[gd_scene load_steps=10 format=3 uid="uid://b54f042muojun"]

[ext_resource type="Texture2D" uid="uid://ctwmwau6q0h2" path="res://scenes/environment/wall/wall.png" id="1_iyq7q"]
[ext_resource type="Texture2D" uid="uid://td7rb13l2h5x" path="res://scenes/environment/floor/floor.png" id="1_pw3xs"]
[ext_resource type="Script" path="res://scenes/environment/level/enemy_spawner.gd" id="3_jlef0"]
[ext_resource type="Script" path="res://scenes/environment/level/navigation_region.gd" id="3_q4n6p"]

[sub_resource type="GDScript" id="GDScript_erxrp"]
script/source = "extends Node

@onready var tile_map: TileMap = $TileMap
@onready var enemy_spawner: Node = $EnemySpawner

var rng: RandomNumberGenerator = RandomNumberGenerator.new()
var starting_position: Vector2i
var grid: Array = []
var grid_bounds: Rect2i
var spawn_positions: PackedVector2Array = []

#func _ready():
	#generate(1)

func generate(level_number: int) -> Vector2:
	rng.randomize()
	_generate_grid()
	_paint_floor()
	_place_walls()
	_set_tile_map()
	_generate_navigation_region()
	_generate_spawn_positions()
	enemy_spawner.spawn(spawn_positions, level_number * 10)
	return tile_map.to_global(tile_map.map_to_local(starting_position))
	
func _generate_grid():
	var grid_side_length: int = 100
	grid.resize(grid_side_length)
	for i in grid.size():
		grid[i] = PackedInt32Array()
		grid[i].resize(grid_side_length)
		grid[i].fill(0)

func _paint_floor():
	var length_x: int = grid.size()
	var length_y: int = grid[0].size()
	
	starting_position = Vector2i(grid.size() / 2, grid[0].size() / 2)
	grid_bounds = Rect2i(starting_position, Vector2i.ZERO)
	var walker: Vector2i = starting_position
	grid[walker.x][walker.y] = 1
	
	var iterations = 200
	var itr = 0
	while itr < iterations:
		var direction: Vector2i = _get_random_direction()
		if (walker.x + direction.x > 0 and 
			walker.x + direction.x < length_x - 1 and
			walker.y + direction.y > 0 and
			walker.y + direction.y < length_y - 1):
			walker += direction
			grid[walker.x][walker.y] = 1
			itr += 1

func _get_random_direction() -> Vector2i:
	var directions = [[-1, 0], [1, 0], [0, 1], [0, -1]]
	var direction = directions[rng.randi() % 4]
	return Vector2i(direction[0], direction[1])

func _place_walls():
	for x in grid.size() - 1:
		for y in grid[x].size() - 1:
			if grid[x][y] == 0 and _is_adjacent_to_floor(x, y):
				grid[x][y] = 2
				if x < grid_bounds.position.x:
					grid_bounds.position.x = x
				if x > grid_bounds.end.x:
					grid_bounds.end.x = x
				if y < grid_bounds.position.y:
					grid_bounds.position.y = y
				if y > grid_bounds.end.y:
					grid_bounds.end.y = y

func _is_adjacent_to_floor(x: int, y: int):
	return grid[x+1][y] == 1 or grid[x-1][y] == 1 or grid[x][y+1] == 1 or grid[x][y-1] == 1 or grid[x+1][y+1] == 1 or grid[x-1][y+1] == 1 or grid[x+1][y-1] == 1 or grid[x-1][y-1] == 1

func _set_tile_map():
	tile_map.clear()
	for x in grid.size() - 1:
		for y in grid[x].size():
			if grid[x][y] != 0: tile_map.set_cell(0, Vector2i(x, y), grid[x][y], Vector2i(0, 0))

func _generate_navigation_region():
	var bounds: Rect2 = Rect2(tile_map.to_global(tile_map.map_to_local(grid_bounds.position)), tile_map.to_global(tile_map.map_to_local(grid_bounds.size)))
	$NavigationRegion2D.generate(bounds)

func _generate_spawn_positions():
	spawn_positions.clear()
	for x in grid.size():
		for y in grid[x].size():
			if grid[x][y] == 1 and Vector2i(x - starting_position.x, y - starting_position.y).abs().length() > 5:
				spawn_positions.append(tile_map.to_global(tile_map.map_to_local(Vector2i(x, y))))
"

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_kfp3a"]
texture = ExtResource("1_pw3xs")
texture_region_size = Vector2i(128, 128)
0:0/0 = 0
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_pe5dn"]
resource_name = "wall"
texture = ExtResource("1_iyq7q")
texture_region_size = Vector2i(128, 128)
use_texture_padding = false
0:0/0 = 0
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0
0:0/0/physics_layer_0/polygon_0/points = PackedVector2Array(-64, -64, 64, -64, 64, 64, -64, 64)

[sub_resource type="TileSet" id="TileSet_67fqo"]
tile_size = Vector2i(128, 128)
physics_layer_0/collision_layer = 4
physics_layer_0/collision_mask = 3
sources/1 = SubResource("TileSetAtlasSource_kfp3a")
sources/2 = SubResource("TileSetAtlasSource_pe5dn")

[sub_resource type="NavigationPolygon" id="NavigationPolygon_lxs8k"]
parsed_collision_mask = 4294967292
source_geometry_mode = 1
source_geometry_group_name = &"navigation_polygon_source_group"

[node name="Level" type="Node"]
script = SubResource("GDScript_erxrp")

[node name="TileMap" type="TileMap" parent="." groups=["navigation_polygon_source_group"]]
tile_set = SubResource("TileSet_67fqo")
format = 2
layer_0/name = "terrain"

[node name="NavigationRegion2D" type="NavigationRegion2D" parent="."]
navigation_polygon = SubResource("NavigationPolygon_lxs8k")
script = ExtResource("3_q4n6p")

[node name="EnemySpawner" type="Node" parent="."]
script = ExtResource("3_jlef0")

[connection signal="child_exiting_tree" from="EnemySpawner" to="EnemySpawner" method="_on_child_exiting_tree"]
